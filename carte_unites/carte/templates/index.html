{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Carte des arm√©es napol√©oniennes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Importation des biblioth√®ques MapLibre GL JS -->
  <link href="https://unpkg.com/maplibre-gl@^5.5.0/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@^5.5.0/dist/maplibre-gl.js"></script>

  <!-- Importation des biblioth√®ques Carte Facile -->
  <link href="https://unpkg.com/carte-facile@^0.7.1/dist/carte-facile.css" rel="stylesheet" />
  <script src="https://unpkg.com/carte-facile@^0.7.1/dist/carte-facile.js"></script> 

  <!-- Choices.js -->
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />

  <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
    <header>
        <h1>Carte de la campagne de France (D√©c 1813 - Avril 1814)</h1>

        <div class="faq-actions">
            <a href="{% url 'carte:faq' %}">FAQ</a>
            <a href="{% url 'carte:contact' %}">Contact</a>
        </div>
    </header>

    <main>

      <div class="main-container">

        <section class="controls">
            <div class="control-group">
                <div class="form-item">
                    <label for="dateSelect">S√©lectionner une date :</label>
                    <div class="date-input-group">
                        <input type="date" id="dateSelect" min="1813-12-01" max="1814-04-30" value="1813-12-24">
                        <button onclick="decrementDate()" title="Jour pr√©c√©dent">¬´</button>
                        <button onclick="incrementDate()" title="Jour suivant">¬ª</button>
                    </div>
                </div>

                <div class="form-item">
                    <label for="unitSelect">S√©lectionner une unit√© :</label>
                    <select id="unitSelect" name="unitSelect"></select>
                </div>

                <div class="view-options" id="filters">
                    <label>
                        <input type="checkbox" id="planifieSelect" name="type" checked>
                        Masquer les lieux objectifs
                    </label>
                    <label>
                        <input type="checkbox" id="dateApproxSelect" name="type" checked>
                        Masquer les dates approximatives
                    </label>
                </div>
                <div id="titre_odb">
                  <label>A sous ses ordres : </label>
                  <ul id="commande"></ul>
                  <label>Est sous les ordres de : </label>
                  <ul id="dirige_par"></ul>
                </div>
                
            </div>
        </section>


        <div id="map"></div>
      </div>      
    </main>
</body>
</html>

  <script>

    document.getElementById('titre_odb').style.display = "none";

    // Ajout des deux couches Cassini et Etat-major
    const layer_cassini_etat_major = [ 
          { id: "cassini", type: "raster", source: "cassini", layout: { visibility: "none" } },
          { id: "etatmajor", type: "raster", source: "etatmajor", layout: { visibility: "none" } },
          { id: "OSM", type: "raster", source: "OSM", layout: { visibility: "none" } },
        ]  
        
    const layers_cartes_histo = [ 
          { id: "page65", type: "raster", source: "page65", layout: { visibility: "none" } },
          { id: "page64", type: "raster", source: "page64", layout: { visibility: "none" } },
        ]  
    
    const map = new maplibregl.Map({
      container: "map",
      style: {
        version: 8,
        glyphs:"https://openmaptiles.geo.data.gouv.fr/fonts/{fontstack}/{range}.pbf",
        sprite:"https://openmaptiles.github.io/osm-bright-gl-style/sprite",
        sources: {
          cassini: {
            type: "raster",
            tiles: [
              "https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0" +
              "&LAYER=BNF-IGNF_GEOGRAPHICALGRIDSYSTEMS.CASSINI" +
              "&STYLE=normal" + 
              "&TILEMATRIX={z}&TILECOL={x}&TILEROW={y}&FORMAT=image/png" +
              "&TileMatrixSet=PM"
            ],
            tileSize: 256
          },
          etatmajor: {
            type: "raster",
            tiles: [
              "https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0" +
              "&LAYER=GEOGRAPHICALGRIDSYSTEMS.ETATMAJOR40" +
              "&STYLE=normal" + 
              "&TILEMATRIX={z}&TILECOL={x}&TILEROW={y}&FORMAT=image/jpeg" +
              "&TileMatrixSet=PM"
            ],
            tileSize: 256
          },
          OSM: {
            type: "raster",
            tiles: [
              'https://tile.openstreetmap.org/{z}/{x}/{y}.png'
            ],
            tileSize: 256
          },
          plan_ign: {
            type: "vector",
            tiles: [
              "https://data.geopf.fr/tms/1.0.0/PLAN.IGN/{z}/{x}/{y}.pbf"
            ],
          },
          page64: {
            type: "raster",
            tiles: [
              '/static/fond_carte/page_64/tiles/{z}/{x}/{y}.png'
            ],
            minzoom: 0,
            maxzoom: 12
          },
          page65: {
            type: "raster",
            tiles: [
              '/static/fond_carte/page_65/tiles/{z}/{x}/{y}.png'
            ],
            minzoom: 5,
            maxzoom: 12
          }
        },
        layers: layer_cassini_etat_major.concat(CarteFacile.mapStyles.simple.layers).concat(layers_cartes_histo)
      },
      center: [7.0, 48.8],
      zoom: 6
    });


    
    // Choix du fond de carte avec les boutons radio
    class BasemapControl {
      onAdd(map) {
        this._map = map;

        // Conteneur principal du contr√¥le
        this._container = document.createElement('div');
        this._container.className = 'maplibregl-ctrl maplibregl-ctrl-group';

        // Bouton d'ic√¥ne
        const button = document.createElement('button');
        button.type = 'button';
        button.innerHTML = 'üó∫Ô∏è'; // tu peux remplacer par une ic√¥ne SVG
        button.title = 'Choisir un fond de plan';
        button.addEventListener('click', () => {
          form.classList.toggle('hidden');
        });

        this._container.appendChild(button);

        // Formulaire (cach√© par d√©faut)
        const form = document.createElement('div');
        form.id = 'basemap-form';
        form.className = 'hidden';
        form.innerHTML = `
          <p>Fonds de plans</p>
          <label><input type="radio" name="basemap" value="plan_ign" checked> Carte IGN</label>
          <label><input type="radio" name="basemap" value="OSM"> Open Street Map</label>
          <label><input type="radio" name="basemap" value="cassini"> Carte de Cassini</label>
          <label><input type="radio" name="basemap" value="etatmajor"> Carte de l'√©tat-major (1820-1866)</label>
          <p>Cartes historiques</p>
          <label><input type="checkbox" name="basemap_carte" value="page64"> Est de la France (Thiers p.64)</label>
          <label><input type="checkbox" name="basemap_carte" value="page65"> Champagne (Thiers p.65)</label>
        `;

        this._container.appendChild(form);

        form.onchange = (e) => {
          if (e.target.name === 'basemap') {
            var layers = map.getStyle().layers;
            layers.forEach(layer => {              
              if (layer.source==e.target.value) {
                map.setLayoutProperty(layer.id, 'visibility', 'visible');
              }
              else if (layer.source=="positions" || layer.source=="combats"){
                map.setLayoutProperty(layer.id, 'visibility', 'visible');
              }
              else{
                map.setLayoutProperty(layer.id, 'visibility', 'none');
              }
            });            
          }
          if (e.target.name === 'basemap_carte'){
            var layers = map.getStyle().layers;
            layers.forEach(layer => {              
              if (layer.source==e.target.value) {
                const visibility = map.getLayoutProperty(layer.id, 'visibility');
                if (visibility === 'visible') {
                  map.setLayoutProperty(layer.id, 'visibility', 'none');
                } else {
                  map.setLayoutProperty(layer.id, 'visibility', 'visible');
                }
              }
            })
          }
        };

        this._container.appendChild(form);
        return this._container;
      }

      onRemove() {
        this._container.parentNode.removeChild(this._container);
        this._map = undefined;
      }
    }

    // Ajout du contr√¥le du fond de carte dans l'angle en haut √† gauche
    map.addControl(new BasemapControl(), 'top-left');

    // Echelle dans le syst√®me m√©trique
    const scale = new maplibregl.ScaleControl({
      maxWidth: 200,
      unit: 'metric'
    });
    const nav = new maplibregl.NavigationControl();
    map.addControl(nav, 'top-right');

    // Instanciation des couches
    map.addControl(scale);
    map.on('load', async () => {
      
      // On ajoute l'ic√¥ne pour les combats
      image = await map.loadImage('/static/icons/lieu_combat.png');
      map.addImage('icone_combat', image.data);
      
      // Chargement des images, pas r√©ussi √† faire plus propre...
      image = await map.loadImage('/static/icons/inconnu_bleu.png');
      map.addImage('inconnubleu', image.data);
      image = await map.loadImage('/static/icons/inconnu_rouge.png');
      map.addImage('inconnurouge', image.data);
      image = await map.loadImage('/static/icons/inconnu_inconnu.png');
      map.addImage('inconnuinconnu', image.data);
      image = await map.loadImage('/static/icons/corps_bleu.png');
      map.addImage('corpsbleu', image.data);
      image = await map.loadImage('/static/icons/corps_rouge.png');
      map.addImage('corpsrouge', image.data);
      image = await map.loadImage('/static/icons/corps_inconnu.png');
      map.addImage('corpsinconnu', image.data);
      image = await map.loadImage('/static/icons/division_bleu.png');
      map.addImage('divisionbleu', image.data);
      image = await map.loadImage('/static/icons/division_rouge.png');
      map.addImage('divisionrouge', image.data);
      image = await map.loadImage('/static/icons/division_inconnu.png');
      map.addImage('divisioninconnu', image.data);
      image = await map.loadImage('/static/icons/brigade_bleu.png');
      map.addImage('brigadebleu', image.data);
      image = await map.loadImage('/static/icons/brigade_rouge.png');
      map.addImage('brigaderouge', image.data);
      image = await map.loadImage('/static/icons/brigade_inconnu.png');
      map.addImage('brigadeinconnu', image.data);
      image = await map.loadImage('/static/icons/regiment_bleu.png');
      map.addImage('regimentbleu', image.data);
      image = await map.loadImage('/static/icons/regiment_rouge.png');
      map.addImage('regimentrouge', image.data);
      image = await map.loadImage('/static/icons/regiment_inconnu.png');
      map.addImage('regimentinconnu', image.data);
      image = await map.loadImage('/static/icons/bataillon_bleu.png');
      map.addImage('bataillonbleu', image.data);
      image = await map.loadImage('/static/icons/bataillon_rouge.png');
      map.addImage('bataillonrouge', image.data);
      image = await map.loadImage('/static/icons/bataillon_inconnu.png');
      map.addImage('batailloninconnu', image.data);
      image = await map.loadImage('/static/icons/armee_bleu.png');
      map.addImage('armeebleu', image.data);
      image = await map.loadImage('/static/icons/armee_rouge.png');
      map.addImage('armeerouge', image.data);
      image = await map.loadImage('/static/icons/armee_inconnu.png');
      map.addImage('armeeinconnu', image.data);
      image = await map.loadImage('/static/icons/escadron_bleu.png');
      map.addImage('escadronbleu', image.data);
      image = await map.loadImage('/static/icons/escadron_rouge.png');
      map.addImage('escadronrouge', image.data);
      image = await map.loadImage('/static/icons/escadron_inconnu.png');
      map.addImage('escadroninconnu', image.data);
      
      // On ajoute la couche des positions
      map.addSource('positions', {
        type: 'geojson',
        data: {
          type: 'FeatureCollection',
          features: []
        }
      });

      // On ajoute la couche des combats
      map.addSource('combats', {
        type: 'geojson',
        data: {
          type: 'FeatureCollection',
          features: []
        }
      });

      // Symboles points pour le placement des unit√©s
      map.addLayer({
        id: 'unit-points',
        type: 'symbol',
        source: 'positions',
        layout: {
          'icon-image': [
            'concat',
            ['get', 'echelon'], // armee, corps, division...
            [
              'case',
              ['==', ['get', 'camp'], 'FRANCAIS'], 'bleu',
              ['==', ['get', 'camp'], 'COALISES'], 'rouge',
              ['==', ['get', 'camp'], 'NONE'], 'inconnu',
              'inconnu' // fallback
            ]
          ],
          "icon-size": 0.3,
          'text-field': ['get', 'unite'],
          'text-anchor': 'top',
          'text-offset': [0, 1.0],
          'symbol-sort-key': [
            'case',
            ['==', ['get', 'echelon'], 'armee'], 1,
            ['==', ['get', 'echelon'], 'corps'], 2,
            ['==', ['get', 'echelon'], 'division'], 3,
            ['==', ['get', 'echelon'], 'brigade'], 4,
            ['==', ['get', 'echelon'], 'regiment'], 5,
            ['==', ['get', 'echelon'], 'bataillon'], 6,
            ['==', ['get', 'echelon'], 'inconnu'], 7,
            8 // fallback
          ]
        }
      });

      // Icones pour les batailles
      map.addLayer({
          id: 'batailles-layer',
          type: 'symbol',
          source: 'combats',
          layout: {
            'icon-image': 'icone_combat',
            'icon-size': 0.05, // ajuste la taille
            'icon-allow-overlap': true
          }
      });

      updateDataDate("1814-01-01");
      filter();
    });

    // Pop-up sur les positions
    map.on('click', 'unit-points', (e) => {
      const coordinates = e.features[0].geometry.coordinates.slice();
      const props = e.features[0].properties;      
      new maplibregl.Popup()
        .setLngLat(coordinates)
        .setHTML(props.popup)
        .addTo(map);
    });

    // Pop-up sur les batailles
    map.on('click', 'batailles-layer', (e) => {
      const coordinates = e.features[0].geometry.coordinates.slice();
      const props = e.features[0].properties;      
      new maplibregl.Popup()
        .setLngLat(coordinates)
        .setHTML(props.popup)
        .addTo(map);
    });

    

    // Ajout des courbes de niveau. Pas tr√®s utile √† cette √©chelle...
    CarteFacile.addOverlay(map, CarteFacile.Overlay.levelCurves);

    // Mise √† jour de la carte lors de la s√©lection d'une unit√©
    document.getElementById('unitSelect').addEventListener('change', function () {
      const selectedUnit = this.value;

      fetch(`/positions_par_unite?unite=${selectedUnit}`)
        .then(res => res.json())
        .then(data => {
          if (map.getSource('positions')) {
            map.getSource('positions').setData(data["position"]);
            map.setLayoutProperty('unit-points', 'text-field', ['get', 'date']);
            map.getSource('combats').setData(data["combats"]);
            
            document.getElementById('titre_odb').style.display = "block";
            const ul = document.getElementById("commande");
            ul.innerHTML = ""; // vider la liste
            // Construire les <li>
            data["a_sous_ses_ordres"].forEach(unite => {
                const li = document.createElement("li");
                li.textContent = unite;
                ul.appendChild(li);
            });

            const ul2 = document.getElementById("dirige_par");
            ul2.innerHTML = ""; // vider la liste
            // Construire les <li>
            data["est_commande_par"].forEach(unite => {
                const li2 = document.createElement("li");
                li2.textContent = unite;
                ul2.appendChild(li2);
            });
          }
        })
      });

    // Mise √† jour de la carte lors de la s√©lection d'une date
    document.getElementById('dateSelect').addEventListener('change', function () {
      const selectedDate = this.value;
      updateDataDate(selectedDate);
    });



    function updateDataDate(selectedDate) {
      fetch(`/positions_par_date?date=${selectedDate}`)
      .then(res => res.json())
      .then(data => {
        if (map.getSource('positions')) {                             
          map.getSource('positions').setData(data["position"]);
          map.setLayoutProperty('unit-points', 'text-field', ['get', 'unite']);
          map.getSource('combats').setData(data["combats"]);
          document.getElementById('titre_odb').style.display = "none";
        }
      })
    }

    function filter(){
      const valuePlanifie = document.getElementById("planifieSelect").checked;      
      const valueDateApprox = document.getElementById("dateApproxSelect").checked;     
      if  (valuePlanifie && valueDateApprox) {
        map.setFilter(
          'unit-points', 
          [
            "all",
            ["==", ["get", "date_approx"], false],
            ["==", ["get", "planifie"], false]
          ]
        );
        map.setFilter('batailles-layer', ['==', ['get', 'date_approx'], false]);
      } else if (valuePlanifie) {
        map.setFilter('unit-points', ['==', ['get', 'planifie'], false]);
      } else if (valueDateApprox) {
        map.setFilter('unit-points', ['==', ['get', 'date_approx'], false]);
        map.setFilter('batailles-layer', ['==', ['get', 'date_approx'], false]);
      } else {
        map.setFilter('unit-points', null);
        map.setFilter('batailles-layer', null);
      }
    }

    // Gestion du filtre sur les dates approximatives et les mouvements planifi√©s
    document.getElementById('filters').addEventListener('change', (e) => {
      filter();
    });

    // On remplit le <select> avec le nom des unit√©s
    fetch('/units/')
    .then(response => response.json())
    .then(data => {
      const unitSelect = document.getElementById('unitSelect');
      // Remplir manuellement le <select>
      data.forEach(unit => {
        const option = document.createElement('option');
        option.value = unit.id;
        option.text = unit.text;
        unitSelect.appendChild(option);
      });

      // Initialiser Choices.js apr√®s ajout
      new Choices('#unitSelect');
    });


    function decrementDate() {
        const input = document.getElementById('dateSelect');
        if (input.value) {
            const currentDate = new Date(input.value);
            currentDate.setDate(currentDate.getDate() - 1); // soustrait 1 jour
            input.value = currentDate.toISOString().split('T')[0];
        } else {
            const today = new Date();
            today.setDate(today.getDate() - 1);
            input.value = today.toISOString().split('T')[0];
        }
        updateDataDate(input.value);
    }


    // Increment date
    function incrementDate() {
      const input = document.getElementById('dateSelect');
      if (input.value) {
          const currentDate = new Date(input.value);
          currentDate.setDate(currentDate.getDate() + 1); // ajoute 1 jour
          input.value = currentDate.toISOString().split('T')[0]; // format YYYY-MM-DD
      } else {
          // Si aucune date s√©lectionn√©e, mettre aujourd‚Äôhui + 1
          const today = new Date();
          today.setDate(today.getDate() + 1);
          input.value = today.toISOString().split('T')[0];
      }
      updateDataDate(input.value);
    }


    document.addEventListener('click', (e) => {
      if (!e.target.classList) return;
      if (!e.target.classList.contains('map-popup__toggle')) return;

      const btn = e.target;
      const quoteId = btn.getAttribute('aria-controls');
      const quote = document.getElementById(quoteId);
      if (!quote) return;

      const expanded = btn.getAttribute('aria-expanded') === 'true';
      if (expanded) {
        // r√©duire
        quote.classList.add('map-popup__quote--collapsed');
        btn.textContent = 'Lire la suite';
        btn.setAttribute('aria-expanded','false');
      } else {
        // d√©plier
        quote.classList.remove('map-popup__quote--collapsed');
        btn.textContent = 'R√©duire';
        btn.setAttribute('aria-expanded','true');
      }
    });
    

  </script>
</html>
