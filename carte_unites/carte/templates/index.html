<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Carte des arm√©es napol√©oniennes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Importation des biblioth√®ques MapLibre GL JS -->
  <link href="https://unpkg.com/maplibre-gl@^5.5.0/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@^5.5.0/dist/maplibre-gl.js"></script>

  <!-- Importation des biblioth√®ques Carte Facile -->
  <link href="https://unpkg.com/carte-facile@^0.7.1/dist/carte-facile.css" rel="stylesheet" />
  <script src="https://unpkg.com/carte-facile@^0.7.1/dist/carte-facile.js"></script> 

  <!-- Choices.js -->
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />

  
    <style>
        /* Police d'inspiration classique */
        body {
            /*font-family: 'Georgia', serif;*/
            font-family: "Helvetica Neue", Arial, Helvetica, sans-serif;
            background-color: #f8f5f0; /* ivoire doux */
            color: #2e2e2e;
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        /* En-t√™te solennel */
        header {
            background-color: #001f3f; /* bleu empire */
            color: #fff8e1; /* blanc chaud */
            padding: 1.8rem;
            text-align: center;
            border-bottom: 5px solid #c9a94d; /* dor√© */
        }

        header h1 {
            margin: 0;
            font-size: 1.5rem;
            letter-spacing: 1px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-item {
            display: flex;
            flex-direction: column; /* Label au-dessus du champ */
            align-items: flex-start;
            gap: 0.5rem;
        }

        .date-input-group {
            display: flex;
            width: 100%; /* Prend toute la largeur disponible dans le panneau */
        }

        /* Formulaires */
        form label, .form-item > label {
            font-weight: bold;
            color: #2b2b2b;
        }

        /* Unifie le style de l'input de date et du select personnalis√© */
        input[type="date"],
        .choices__inner {
            padding: 0.8rem; /* Un peu plus de padding pour un meilleur alignement vertical */
            border: 1px solid #bbb;
            border-radius: 4px;
            background-color: #fefefe;
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box;
            min-height: auto; /* N√©cessaire pour Choices.js */
        }

        /* Ajustement pour que la bordure ne change pas de couleur au focus */
        .is-focused .choices__inner {
            border-color: #bbb;
        }

        .date-input-group input[type="date"] {
            flex-grow: 1; /* L'input s'√©tire */
        }

        .date-input-group button {
            flex-shrink: 0; /* Les boutons ne r√©tr√©cissent pas */
        }

        /* Boutons */
        button {
            padding: 0.6rem 1.2rem;
            background-color: #001f3f;
            color: #fff8e1;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #003366;
        }

        .view-options label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #444;
            font-size: 0.95rem;
            font-weight: bold;
        }

        #titre_odb label {
            font-weight: bold;
            color: #2b2b2b;
        }

        /* --- AJOUTS POUR LA MISE EN PAGE --- */

        /* 1. Le conteneur principal devient un conteneur flex */
        .main-container {
            display: flex;
            /* Calcule la hauteur restante de la fen√™tre (100vh) moins la hauteur approximative du header */
            height: calc(100vh - 105px); /* Ajustez cette valeur si votre header change */
        }

        /* 2. On donne une taille fixe au panneau de contr√¥le (l'ancienne section.controls) */
        .main-container .controls {
            flex: 0 0 380px; /* Ne grandit pas, ne r√©tr√©cit pas, largeur de base 380px */
            padding: 1.5rem;
            background-color: #ffffff;
            overflow-y: auto; /* Ajoute une barre de d√©filement si le contenu est trop grand */
            border-right: 2px solid #ded6c3; /* Ligne de s√©paration */
        }

        .main-container .controls .choices {
          width: 300px;
        }

        /* 3. La carte prend tout le reste de la place */
        .main-container #map {
            flex-grow: 1; /* Permet √† la carte de grandir */
            height: 100%; /* La carte prend 100% de la hauteur de son parent */
        }

        .deux-colonnes {
          width: 60%;           /* largeur totale du bloc */
          margin: auto;         /* centrage horizontal */
          column-count: 2;      /* nombre de colonnes */
          column-gap: 2em;      /* espace entre colonnes */
          text-align: justify;  /* optionnel : aligner le texte */
          padding-top: 1%;
        }

        .bloc {
          break-inside: avoid;
        }


        /* Container de la popup */
        .map-popup{
          font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
          background: #ffffff;
          color: #1f2937; /* gris fonc√© */
          border-radius: 10px;
          box-shadow: 0 6px 20px rgba(31,41,55,0.2);
          padding: 12px;
          max-width: 320px;   /* ajuster selon besoin */
          width: max-content;
          line-height: 1.35;
          box-sizing: border-box;
          -webkit-font-smoothing:antialiased;
        }

        /* Header (titre + meta) */
        .map-popup__header{
          display: flex;
          flex-direction: column;
          gap: 6px;
          margin-bottom: 8px;
        }

        /* Nom / titre */
        .map-popup__title{
          font-weight: 700;
          font-size: 15px;
          letter-spacing: -0.01em;
          overflow-wrap: anywhere; /* d√©coupe les mots longs */
        }

        /* Meta (date + lieu) */
        .map-popup__meta{
          display: flex;
          gap: 8px;
          align-items: center;
          font-size: 12px;
          color: #6b7280; /* gris moyen */
        }

        /* S√©parateur si besoin entre date et lieu */
        .map-popup__date::after{
          content: "‚Ä¢";
          margin: 0 6px;
          color: #d1d5db;
        }

        /* Citation (blockquote) */
        .map-popup__quote{
          margin: 0;
          padding-left: 10px;
          border-left: 3px solid #e6eef9; /* accent l√©ger */
          font-style: italic;
          font-size: 13px;
          color: #374151;
          max-height: none;
          overflow: visible;
          transition: max-height 0.25s ease;
        }

        /* Version "reduite" pour citations longues : masque apr√®s N lignes */
        .map-popup__quote--collapsed{
          display: -webkit-box;
          -webkit-line-clamp: 4; /* nombre de lignes visibles par d√©faut */
          -webkit-box-orient: vertical;
          overflow: hidden;
          max-height: calc(1.35em * 4); /* fallback */
        }

        /* Bouton toggle "Lire la suite" */
        .map-popup__toggle{
          display: inline-block;
          margin-top: 8px;
          background: transparent;
          border: none;
          color: #2563eb; /* bleu action */
          cursor: pointer;
          padding: 6px 0;
          font-size: 13px;
          text-decoration: underline;
          line-height: 1;
        }

        /* Focus et accessibilit√© */
        .map-popup__toggle:focus,
        .map-popup__title:focus{
          outline: 3px solid rgba(37,99,235,0.15);
          outline-offset: 2px;
          border-radius: 6px;
        }

        /* Dark mode (optionnel) */
        @media (prefers-color-scheme: dark){
          .map-popup{
            background: #0f1724;
            color: #e6eef8;
            box-shadow: 0 6px 20px rgba(2,6,23,0.6);
          }
          .map-popup__meta{ color:#9ca3af; }
          .map-popup__quote{ border-left-color: rgba(255,255,255,0.06); color:#d1d5db; }
          .map-popup__toggle{ color: #93c5fd;}
        }

        /* Responsive: r√©duire largeur sur petits √©crans */
        @media (max-width: 420px){
          .map-popup{ max-width: 88vw; padding:10px; }
        }

        /* Supprime le cadre/ombre de MapLibre */
        .maplibregl-popup-content {
          background: transparent !important;
          box-shadow: none !important;
          border: none !important;
          padding: 0 !important;
        }

        /* Supprime le petit triangle (la fl√®che) */
        .maplibregl-popup-tip {
          display: none !important;
        }

        #basemap-form {
          margin-top: 3px;
          padding: 5px;
          background: white;
          font-size: 14px;
          text-align: left;
        }

        #basemap-form label {
          display: block;
          margin-bottom: 4px;
        }

        #basemap-form p {
          font-weight: bold;
          margin: 5px;
        }

        .hidden {
          display: none;
        }

    </style>
</head>
<body>
    <header>
        <h1>Carte de la campagne de France (D√©c 1813 - Avril 1814)</h1>
    </header>

    <main>

      <div class="main-container">

        <section class="controls">
            <div class="control-group">
                <div class="form-item">
                    <label for="dateSelect">S√©lectionner une date :</label>
                    <div class="date-input-group">
                        <input type="date" id="dateSelect" min="1813-12-01" max="1814-04-30" value="1814-01-01">
                        <button onclick="decrementDate()" title="Jour pr√©c√©dent">¬´</button>
                        <button onclick="incrementDate()" title="Jour suivant">¬ª</button>
                    </div>
                </div>

                <div class="form-item">
                    <label for="unitSelect">S√©lectionner une unit√© :</label>
                    <select id="unitSelect" name="unitSelect"></select>
                </div>

                <div class="view-options" id="filters">
                    <label>
                        <input type="checkbox" id="planifieSelect" name="type">
                        Masquer les lieux objectifs
                    </label>
                </div>
                <div id="titre_odb">
                  <label>A sous ses ordres : </label>
                  <ul id="commande"></ul>
                  <label>Est sous les ordres de : </label>
                  <ul id="dirige_par"></ul>
                </div>
                
            </div>
        </section>


        <div id="map"></div>
      </div>
      <div class="deux-colonnes">
        <div class="bloc">
          <h4>Introduction</h4>
          <p>
            Les ouvrages pr√©sentant les op√©rations militaires souffrent g√©n√©ralement d'un m√™me d√©faut : les cartes sont assez m√©diocres. L'√©chelle est absente, le r√©seau fluvial ou le r√©seau routier n'est pas repr√©sent√©, le relief est illisible, tous les villages mentionn√©s ne sont pas visibles, les unit√©s ne sont pas plac√©s... L'id√©e de ce petit site est de pr√©senter la campagne de France par les cartes, afin d'aider √† la compr√©hension de cette surprenante campagne o√π malgr√© la forte inf√©riorit√© num√©rique de son arm√©e, Napol√©on parvint √† infliger de nombreux revers aux coalis√©s avant finalement de devoir abdiquer √† Fontainebleau.
          </p>

          <p>
            Une particularit√© de ce site consiste dans l'acquisition des donn√©es. En effet, la cha√Æne de traitement pour les r√©cup√©rer est enti√®rement automatique gr√¢ce aux mod√®les de langages qui se sont fortement d√©velopp√©s ces derni√®res ann√©es et permettent de nouvelles opportunit√©s dans le traitement de gros volumes de texte.
            Le code source est disponible sur <a target="_blank" href="https://github.com/CelestinHuet/Weil_1814">Github</a>.
          </p>

        </div>
         

        
        <div class="bloc">
          <h4>Comment sont acquises les donn√©es ?</h4>
          <p>
            Sch√©matiquement, la d√©marche est la suivante :
            <ul>
              <li>Les ouvrages sont pass√©s du format image au format texte √† l'aide de Tesseract.</li>
              <li>Chaque page de chaque ouvrage est pass√©e une premi√®re fois √† un LLM, en l'occurence Gemini Flash 2.5, pour s√©parer le corps du texte et les notes de bas de page.</li>
              <li>Les paragraphes √† cheval sur deux pages sont regroup√©s.</li>
              <li>Chaque page est pass√© une deuxi√®me fois √† un LLM. Le LLM extrait les positions des unit√©s, les dates, le camp des unit√©s, les relations de commandement et de subordination entre les unit√©s et les combats. Une unit√© peut √™tre un g√©n√©ral ou bien une entit√© comme un corps d'arm√©e, une division... Une distinction est faite entre les positions qui sont des objectifs (le g√©n√©ral donne l'ordre de se porter sur telle ville) et les positions qui sont r√©ellement occup√©es par les unit√©s.</li>
              <li>Via Open Street Map, on r√©cup√®re les coordonn√©es de chaque lieu.</li>
              <li>On ins√®re dans la base de donn√©es les unit√©s et les lieux.</li>
              <li>On fusionne les unit√©s qui ont le m√™me nom.</li>
              <li>Chaque lieu peut poss√©der plusieurs homonymes : Bar peut aussi bien repr√©senter Bar-sur-Aube que Bar-sur-Seine. Pour trouver l'homonyme le plus probable, on cherche pour chaque unit√© le chemin le plus court qu'elle peut parcourir dans la campagne.</li>
              <li>On contr√¥le le r√©sultat de l'algorithme : si la moyenne journali√®re d'une unit√© est trop √©lev√©, alors il y a une erreur de localisation.</li>
              <li>On d√©termine l'√©chelon des unit√©s : arm√©e, corps d'arm√©e, division, brigade, r√©giment, bataillon, escadron...</li>
              <li>On essaye de d√©terminer le camp pour les unit√©s dont il n'a pas √©t√© identifi√© par le LLM.</li>
            </ul>
          </p>
        </div>
        
        <div class="bloc">
          <h4>√Ä quelles erreurs faut-il s'attendre ?</h4>

          <p>
            Comme l'algorithme est automatis√©, il faut √™tre conscient qu'il n'est pas parfait et que des erreurs ont pu se glisser. Voici quelques types d'erreurs d√©j√† identifi√©s :
            <ul>
              <li>Tesseract n'est pas tr√®s bon pour lire les nombres donc les dates peuvent √™tre erron√©es. Quelques contr√¥les ont √©t√© ajout√©s, mais il reste des erreurs. Il n'est pas tr√®s performants non plus sur certaines polices d'√©critures et pour les noms propres. Un g√©n√©ral peut donc √™tre √©crit de plusieurs mani√®res diff√©rentes, et ce malgr√© les algorithmes de fusion d'unit√©s. De m√™me, les citations peuvent contenir des fautes d'ortographes.</li>
              <li>Le num√©ro de page des sources peut avoir un d√©calage d'une page. Cela est d√ª au regroupement des paragraphes qui sont √† cheval sur deux pages.</li>
              <li>Certains noms de villes ou de hameaux ont √©t√© modifi√©s (Sainte-Croix est actuellement Sainte-Croix-en-Plaine par exemple), voire ont compl√®tement disparus mais d'autres localit√©s avec le m√™me toponyme continuent d'exister. L'unit√© sera alors mal plac√©e.</li>
              <li>Certains lieux sont trop vagues, notamment les cours d'eau les expressions comme "rive gauche" ou les noms de r√©gion (Savoie).</li>
              <li>Dans les √©chelons, il peut y avoir confusion entre un corps d'arm√©e et un autre √©chelon. En effet, l'expression "un corps" est r√©guli√®rement utilis√©e pour d√©signer tout type de formation.</li>
            </ul>
          </p>
        </div>

        
        <div class="bloc">
          <h4>Quels sont les ouvrages utilis√©s ?</h4>

          <p>
            Les ouvrages utilis√©s sont les suivants :
            <ul><a target="_blank" href="https://books.google.fr/books/about/Geschichte_des_Krieges_1814_in_Frankreic.html?id=m0BBAAAAcAAJ&redir_esc=y">Bogdanovich, Geschichte des Krieges 1814 in Frankreich und des Sturzes Napoleon's I.</a></ul>
            <ul><a target="_blank" href="https://gallica.bnf.fr/ark:/12148/bpt6k930786r">Bouvier, F√©lix, Les premiers combats de 1814 : prologue de la Campagne de France dans les Vosges</a></ul>
            <ul><a target="_blank" href="https://books.google.fr/books/about/Le_g%C3%A9n%C3%A9ral_Maison_et_le_1er_corps_de_l.html?id=cqakgvLoH0oC&redir_esc=y">Calmon-Maison, Jean, Le g√©n√©ral Maison et le 1er corps de la Grande Arm√©e</a></ul>
            <ul><a target="_blank" href="https://books.google.fr/books/about/Pr%C3%A9cis_historique_des_op%C3%A9rations_de_l.html?hl=fr&id=GiHUdyDROhYC&redir_esc=y">du Casse, Albert, Pr√©cis historique des op√©rations de l'arm√©e de Lyon en 1814</a></ul>
            <ul><a target="_blank" href="https://gallica.bnf.fr/ark:/12148/bpt6k6356047k.texteImage">Foch, Ferdinand, La bataille de Laon, mars 1814</a></ul>
            <ul><a target="_blank" href="https://books.google.fr/books/about/Journal_des_Op%C3%A9rations_du_Sixi%C3%A8me_Corp.html?id=GRtbAAAAcAAJ&redir_esc=y">Fabvier, Charles Nicolas, Journal des op√©rations du Sixi√®me corps pendant la campagne de France en 1814</a></ul>
            <ul><a target="_blank" href="https://gallica.bnf.fr/ark:/12148/bpt6k69568c/f477.item.r=M%C3%A9moires%20du%20mar%C3%A9chal%20de%20Grouchy">Grouchy (Marquis de), M√©moires du Mar√©chal de Grouchy, livres XII et XIII</a></ul>
            <ul><a target="_blank" href="https://books.google.fr/books/about/Geschichte_des_Feldzuges_1814_gegen_Fran.html?id=cOlcyuxsqm4C&redir_esc=y">Hiller, Fritz von, Geschichte des Feldzuges 1814 gegen Frankreich unter besonderer Ber√ºcksichtigung der Anteilnahme der K√∂niglich w√ºrttembergischen Truppen</a></ul>
            <ul><a target="_blank" href="https://gallica.bnf.fr/ark:/12148/bpt6k63657773.texteImage">Koch, Fr√©d√©ric, M√©moire pour servir √† l'histoire de la campagne de 1814</a></ul>
            <ul><a target="_blank" href="https://gallica.bnf.fr/ark:/12148/bpt6k695629/f438.item.r=M%C3%A9moires%20du%20mar%C3%A9chal%20Marmont,%20duc%20de%20Raguse#">Marmont, Mar√©chal, M√©moires du duc de Raguse</a></ul>
            <ul><a target="_blank" href="https://gallica.bnf.fr/ark:/12148/bpt6k6369024s/f89.item.texteImage#">P√©tiet, Auguste, Journal historique de la division de cavalerie l√©g√®re du 5e corps de cavalerie, pendant la campagne en 1814</a></ul>
            <ul><a target="_blank" href="https://gallica.bnf.fr/ark:/12148/bpt6k930585r/f574.item#">S√©gur, Philippe-Paul (g√©n√©ral, comte de), La Campagne de France, du Rhin √† Fontainebleau</a></ul>
            <ul><a target="_blank" href="https://gallica.bnf.fr/ark:/12148/bpt6k64651q.texteImage">Weil, Maurice-Henri (commandant), La Campagne de 1814, d'apr√®s les documents des Archives imp√©riales et royales de la guerre √† Vienne</a></ul>
            <ul><a target="_blank" href="https://gallica.bnf.fr/ark:/12148/bpt6k6562110d/f39.item#">Les combats de Mormant, de Villeneuve-le-Comte et de Montereau (17 et 18 f√©vrier 1814)</a></ul>
          </p>

          <p>
            Les cartes proviennent de l'<a href="https://bibliotheque-martial-lapeyre.napoleon.org/Default/doc/SYRACUSE/15686/atlas-de-l-histoire-du-consulat-et-de-l-empire-dresse-et-dessine-sous-la-direction-de-m-thiers-par-m?_lg=fr-FR">Atlas de l'histoire du Consulat et de l'Empire de Thiers</a>.
          </p>

          <p>Si vous souhaitez obtenir des informations suppl√©mentaires, sugg√©rer de nouvelles fonctionnalit√©s ou remonter des erreurs, n'h√©sitez pas √† utiliser le <a href="{% url 'carte:contact' %}">formulaire de contact</a>.</p>
        </div>
        



      </div>
        


        

    </main>
</body>
</html>

  <script>

    document.getElementById('titre_odb').style.display = "none";

    // Ajout des deux couches Cassini et Etat-major
    const layer_cassini_etat_major = [ 
          { id: "cassini", type: "raster", source: "cassini", layout: { visibility: "none" } },
          { id: "etatmajor", type: "raster", source: "etatmajor", layout: { visibility: "none" } },
          { id: "OSM", type: "raster", source: "OSM", layout: { visibility: "none" } },
        ]  
        
    const layers_cartes_histo = [ 
          { id: "page65", type: "raster", source: "page65", layout: { visibility: "none" } },
          { id: "page64", type: "raster", source: "page64", layout: { visibility: "none" } },
        ]  
    
    const map = new maplibregl.Map({
      container: "map",
      style: {
        version: 8,
        glyphs:"https://openmaptiles.geo.data.gouv.fr/fonts/{fontstack}/{range}.pbf",
        sprite:"https://openmaptiles.github.io/osm-bright-gl-style/sprite",
        sources: {
          cassini: {
            type: "raster",
            tiles: [
              "https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0" +
              "&LAYER=BNF-IGNF_GEOGRAPHICALGRIDSYSTEMS.CASSINI" +
              "&STYLE=normal" + 
              "&TILEMATRIX={z}&TILECOL={x}&TILEROW={y}&FORMAT=image/png" +
              "&TileMatrixSet=PM"
            ],
            tileSize: 256
          },
          etatmajor: {
            type: "raster",
            tiles: [
              "https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0" +
              "&LAYER=GEOGRAPHICALGRIDSYSTEMS.ETATMAJOR40" +
              "&STYLE=normal" + 
              "&TILEMATRIX={z}&TILECOL={x}&TILEROW={y}&FORMAT=image/jpeg" +
              "&TileMatrixSet=PM"
            ],
            tileSize: 256
          },
          OSM: {
            type: "raster",
            tiles: [
              'https://tile.openstreetmap.org/{z}/{x}/{y}.png'
            ],
            tileSize: 256
          },
          plan_ign: {
            type: "vector",
            tiles: [
              "https://data.geopf.fr/tms/1.0.0/PLAN.IGN/{z}/{x}/{y}.pbf"
            ],
          },
          page64: {
            type: "raster",
            tiles: [
              '/static/fond_carte/page_64/tiles/{z}/{x}/{y}.png'
            ],
            minzoom: 0,
            maxzoom: 12
          },
          page65: {
            type: "raster",
            tiles: [
              '/static/fond_carte/page_65/tiles/{z}/{x}/{y}.png'
            ],
            minzoom: 5,
            maxzoom: 12
          }
        },
        layers: layer_cassini_etat_major.concat(CarteFacile.mapStyles.simple.layers).concat(layers_cartes_histo)
      },
      center: [2.2, 48.8],
      zoom: 6
    });


    
    // Choix du fond de carte avec les boutons radio
    class BasemapControl {
      onAdd(map) {
        this._map = map;

        // Conteneur principal du contr√¥le
        this._container = document.createElement('div');
        this._container.className = 'maplibregl-ctrl maplibregl-ctrl-group';

        // Bouton d'ic√¥ne
        const button = document.createElement('button');
        button.type = 'button';
        button.innerHTML = 'üó∫Ô∏è'; // tu peux remplacer par une ic√¥ne SVG
        button.title = 'Choisir un fond de plan';
        button.addEventListener('click', () => {
          form.classList.toggle('hidden');
        });

        this._container.appendChild(button);

        // Formulaire (cach√© par d√©faut)
        const form = document.createElement('div');
        form.id = 'basemap-form';
        form.className = 'hidden';
        form.innerHTML = `
          <p>Fonds de plans</p>
          <label><input type="radio" name="basemap" value="plan_ign" checked> Carte IGN</label>
          <label><input type="radio" name="basemap" value="OSM"> Open Street Map</label>
          <label><input type="radio" name="basemap" value="cassini"> Carte de Cassini</label>
          <label><input type="radio" name="basemap" value="etatmajor"> Carte de l'√©tat-major (1820-1866)</label>
          <p>Cartes historiques</p>
          <label><input type="checkbox" name="basemap_carte" value="page64"> Est de la France (Thiers p.64)</label>
          <label><input type="checkbox" name="basemap_carte" value="page65"> Champagne (Thiers p.65)</label>
        `;

        this._container.appendChild(form);

        form.onchange = (e) => {
          if (e.target.name === 'basemap') {
            var layers = map.getStyle().layers;
            layers.forEach(layer => {              
              if (layer.source==e.target.value) {
                map.setLayoutProperty(layer.id, 'visibility', 'visible');
              }
              else if (layer.source=="positions" || layer.source=="combats"){
                map.setLayoutProperty(layer.id, 'visibility', 'visible');
              }
              else{
                map.setLayoutProperty(layer.id, 'visibility', 'none');
              }
            });            
          }
          if (e.target.name === 'basemap_carte'){
            var layers = map.getStyle().layers;
            layers.forEach(layer => {              
              if (layer.source==e.target.value) {
                const visibility = map.getLayoutProperty(layer.id, 'visibility');
                if (visibility === 'visible') {
                  map.setLayoutProperty(layer.id, 'visibility', 'none');
                } else {
                  map.setLayoutProperty(layer.id, 'visibility', 'visible');
                }
              }
            })
          }
        };

        this._container.appendChild(form);
        return this._container;
      }

      onRemove() {
        this._container.parentNode.removeChild(this._container);
        this._map = undefined;
      }
    }

    // Ajout du contr√¥le du fond de carte dans l'angle en haut √† gauche
    map.addControl(new BasemapControl(), 'top-left');

    // Echelle dans le syst√®me m√©trique
    const scale = new maplibregl.ScaleControl({
      maxWidth: 200,
      unit: 'metric'
    });
    const nav = new maplibregl.NavigationControl();
    map.addControl(nav, 'top-right');

    // Instanciation des couches
    map.addControl(scale);
    map.on('load', async () => {
      
      // On ajoute l'ic√¥ne pour les combats
      image = await map.loadImage('/static/icons/lieu_combat.png');
      map.addImage('icone_combat', image.data);
      
      // Chargement des images, pas r√©ussi √† faire plus propre...
      image = await map.loadImage('/static/icons/inconnu_bleu.png');
      map.addImage('inconnubleu', image.data);
      image = await map.loadImage('/static/icons/inconnu_rouge.png');
      map.addImage('inconnurouge', image.data);
      image = await map.loadImage('/static/icons/inconnu_inconnu.png');
      map.addImage('inconnuinconnu', image.data);
      image = await map.loadImage('/static/icons/corps_bleu.png');
      map.addImage('corpsbleu', image.data);
      image = await map.loadImage('/static/icons/corps_rouge.png');
      map.addImage('corpsrouge', image.data);
      image = await map.loadImage('/static/icons/corps_inconnu.png');
      map.addImage('corpsinconnu', image.data);
      image = await map.loadImage('/static/icons/division_bleu.png');
      map.addImage('divisionbleu', image.data);
      image = await map.loadImage('/static/icons/division_rouge.png');
      map.addImage('divisionrouge', image.data);
      image = await map.loadImage('/static/icons/division_inconnu.png');
      map.addImage('divisioninconnu', image.data);
      image = await map.loadImage('/static/icons/brigade_bleu.png');
      map.addImage('brigadebleu', image.data);
      image = await map.loadImage('/static/icons/brigade_rouge.png');
      map.addImage('brigaderouge', image.data);
      image = await map.loadImage('/static/icons/brigade_inconnu.png');
      map.addImage('brigadeinconnu', image.data);
      image = await map.loadImage('/static/icons/regiment_bleu.png');
      map.addImage('regimentbleu', image.data);
      image = await map.loadImage('/static/icons/regiment_rouge.png');
      map.addImage('regimentrouge', image.data);
      image = await map.loadImage('/static/icons/regiment_inconnu.png');
      map.addImage('regimentinconnu', image.data);
      image = await map.loadImage('/static/icons/bataillon_bleu.png');
      map.addImage('bataillonbleu', image.data);
      image = await map.loadImage('/static/icons/bataillon_rouge.png');
      map.addImage('bataillonrouge', image.data);
      image = await map.loadImage('/static/icons/bataillon_inconnu.png');
      map.addImage('batailloninconnu', image.data);
      image = await map.loadImage('/static/icons/armee_bleu.png');
      map.addImage('armeebleu', image.data);
      image = await map.loadImage('/static/icons/armee_rouge.png');
      map.addImage('armeerouge', image.data);
      image = await map.loadImage('/static/icons/armee_inconnu.png');
      map.addImage('armeeinconnu', image.data);
      image = await map.loadImage('/static/icons/escadron_bleu.png');
      map.addImage('escadronbleu', image.data);
      image = await map.loadImage('/static/icons/escadron_rouge.png');
      map.addImage('escadronrouge', image.data);
      image = await map.loadImage('/static/icons/escadron_inconnu.png');
      map.addImage('escadroninconnu', image.data);
      
      // On ajoute la couche des positions
      map.addSource('positions', {
        type: 'geojson',
        data: {
          type: 'FeatureCollection',
          features: []
        }
      });

      // On ajoute la couche des combats
      map.addSource('combats', {
        type: 'geojson',
        data: {
          type: 'FeatureCollection',
          features: []
        }
      });

      // Symboles points pour le placement des unit√©s
      map.addLayer({
        id: 'unit-points',
        type: 'symbol',
        source: 'positions',
        layout: {
          'icon-image': [
            'concat',
            ['get', 'echelon'], // armee, corps, division...
            [
              'case',
              ['==', ['get', 'camp'], 'FRANCAIS'], 'bleu',
              ['==', ['get', 'camp'], 'COALISES'], 'rouge',
              ['==', ['get', 'camp'], 'NONE'], 'inconnu',
              'inconnu' // fallback
            ]
          ],
          "icon-size": 0.3,
          'text-field': ['get', 'unite'],
          'text-anchor': 'top',
          'text-offset': [0, 1.0],
          'symbol-sort-key': [
            'case',
            ['==', ['get', 'echelon'], 'armee'], 1,
            ['==', ['get', 'echelon'], 'corps'], 2,
            ['==', ['get', 'echelon'], 'division'], 3,
            ['==', ['get', 'echelon'], 'brigade'], 4,
            ['==', ['get', 'echelon'], 'regiment'], 5,
            ['==', ['get', 'echelon'], 'bataillon'], 6,
            ['==', ['get', 'echelon'], 'inconnu'], 7,
            8 // fallback
          ]
        }
      });

      // Icones pour les batailles
      map.addLayer({
          id: 'batailles-layer',
          type: 'symbol',
          source: 'combats',
          layout: {
            'icon-image': 'icone_combat',
            'icon-size': 0.05, // ajuste la taille
            'icon-allow-overlap': true
          }
      });

      updateDataDate("1814-01-01");
    });

    // Pop-up sur les positions
    map.on('click', 'unit-points', (e) => {
      const coordinates = e.features[0].geometry.coordinates.slice();
      const props = e.features[0].properties;      
      new maplibregl.Popup()
        .setLngLat(coordinates)
        .setHTML(props.popup)
        .addTo(map);
    });

    // Pop-up sur les batailles
    map.on('click', 'batailles-layer', (e) => {
      const coordinates = e.features[0].geometry.coordinates.slice();
      const props = e.features[0].properties;      
      new maplibregl.Popup()
        .setLngLat(coordinates)
        .setHTML(props.popup)
        .addTo(map);
    });

    

    // Ajout des courbes de niveau. Pas tr√®s utile √† cette √©chelle...
    CarteFacile.addOverlay(map, CarteFacile.Overlay.levelCurves);

    // Mise √† jour de la carte lors de la s√©lection d'une unit√©
    document.getElementById('unitSelect').addEventListener('change', function () {
      const selectedUnit = this.value;

      fetch(`/positions_par_unite?unite=${selectedUnit}`)
        .then(res => res.json())
        .then(data => {
          if (map.getSource('positions')) {
            map.getSource('positions').setData(data["position"]);
            map.setLayoutProperty('unit-points', 'text-field', ['get', 'date']);
            map.getSource('combats').setData(data["combats"]);
            
            document.getElementById('titre_odb').style.display = "block";
            const ul = document.getElementById("commande");
            ul.innerHTML = ""; // vider la liste
            // Construire les <li>
            data["a_sous_ses_ordres"].forEach(unite => {
                const li = document.createElement("li");
                li.textContent = unite;
                ul.appendChild(li);
            });

            const ul2 = document.getElementById("dirige_par");
            ul2.innerHTML = ""; // vider la liste
            // Construire les <li>
            data["est_commande_par"].forEach(unite => {
                const li2 = document.createElement("li");
                li2.textContent = unite;
                ul2.appendChild(li2);
            });
          }
        })
      });

    // Mise √† jour de la carte lors de la s√©lection d'une date
    document.getElementById('dateSelect').addEventListener('change', function () {
      const selectedDate = this.value;
      updateDataDate(selectedDate);
    });



    function updateDataDate(selectedDate) {
      fetch(`/positions_par_date?date=${selectedDate}`)
      .then(res => res.json())
      .then(data => {
        if (map.getSource('positions')) {                             
          map.getSource('positions').setData(data["position"]);
          map.setLayoutProperty('unit-points', 'text-field', ['get', 'unite']);
          map.getSource('combats').setData(data["combats"]);
          document.getElementById('titre_odb').style.display = "none";
        }
      })
    }

    
    // Filtre sur l'√©tat "planifi√©" des positions
    document.getElementById('filters').addEventListener('change', (e) => {
      const value = document.getElementById("planifieSelect").checked;     
      // Si "Tous", on retire le filtre
      if  (value) {
        map.setFilter('unit-points', ['==', ['get', 'planifie'], false]);
      } else {
        // Sinon, on applique un filtre sur la propri√©t√© "type"
        map.setFilter('unit-points', null);
      }
    });

    // On remplit le <select> avec le nom des unit√©s
    fetch('/units/')
    .then(response => response.json())
    .then(data => {
      const unitSelect = document.getElementById('unitSelect');
      // Remplir manuellement le <select>
      data.forEach(unit => {
        const option = document.createElement('option');
        option.value = unit.id;
        option.text = unit.text;
        unitSelect.appendChild(option);
      });

      // Initialiser Choices.js apr√®s ajout
      new Choices('#unitSelect');
    });


    function decrementDate() {
        const input = document.getElementById('dateSelect');
        if (input.value) {
            const currentDate = new Date(input.value);
            currentDate.setDate(currentDate.getDate() - 1); // soustrait 1 jour
            input.value = currentDate.toISOString().split('T')[0];
        } else {
            const today = new Date();
            today.setDate(today.getDate() - 1);
            input.value = today.toISOString().split('T')[0];
        }
        updateDataDate(input.value);
    }


    // Increment date
    function incrementDate() {
      const input = document.getElementById('dateSelect');
      if (input.value) {
          const currentDate = new Date(input.value);
          currentDate.setDate(currentDate.getDate() + 1); // ajoute 1 jour
          input.value = currentDate.toISOString().split('T')[0]; // format YYYY-MM-DD
      } else {
          // Si aucune date s√©lectionn√©e, mettre aujourd‚Äôhui + 1
          const today = new Date();
          today.setDate(today.getDate() + 1);
          input.value = today.toISOString().split('T')[0];
      }
      updateDataDate(input.value);
    }


    document.addEventListener('click', (e) => {
      if (!e.target.classList) return;
      if (!e.target.classList.contains('map-popup__toggle')) return;

      const btn = e.target;
      const quoteId = btn.getAttribute('aria-controls');
      const quote = document.getElementById(quoteId);
      if (!quote) return;

      const expanded = btn.getAttribute('aria-expanded') === 'true';
      if (expanded) {
        // r√©duire
        quote.classList.add('map-popup__quote--collapsed');
        btn.textContent = 'Lire la suite';
        btn.setAttribute('aria-expanded','false');
      } else {
        // d√©plier
        quote.classList.remove('map-popup__quote--collapsed');
        btn.textContent = 'R√©duire';
        btn.setAttribute('aria-expanded','true');
      }
    });
    

  </script>
</html>
