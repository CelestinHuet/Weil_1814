<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Carte des armées napoléoniennes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Importation des bibliothèques MapLibre GL JS -->
  <link href="https://unpkg.com/maplibre-gl@^5.5.0/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@^5.5.0/dist/maplibre-gl.js"></script>

  <!-- Importation des bibliothèques Carte Facile -->
  <link href="https://unpkg.com/carte-facile@^0.7.1/dist/carte-facile.css" rel="stylesheet" />
  <script src="https://unpkg.com/carte-facile@^0.7.1/dist/carte-facile.js"></script> 

  <!-- Choices.js -->
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />

  
    <style>
        /* Police d'inspiration classique */
        body {
            font-family: 'Georgia', serif;
            background-color: #f8f5f0; /* ivoire doux */
            color: #2e2e2e;
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        /* En-tête solennel */
        header {
            background-color: #001f3f; /* bleu empire */
            color: #fff8e1; /* blanc chaud */
            padding: 2rem;
            text-align: center;
            border-bottom: 5px solid #c9a94d; /* doré */
        }

        header h1 {
            margin: 0;
            font-size: 1.8rem;
            letter-spacing: 1px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-item {
            display: flex;
            flex-direction: column; /* Label au-dessus du champ */
            align-items: flex-start;
            gap: 0.5rem;
        }

        .date-input-group {
            display: flex;
            width: 100%; /* Prend toute la largeur disponible dans le panneau */
        }

        /* Formulaires */
        form label, .form-item > label {
            font-weight: bold;
            color: #2b2b2b;
        }

        /* Unifie le style de l'input de date et du select personnalisé */
        input[type="date"],
        .choices__inner {
            padding: 0.8rem; /* Un peu plus de padding pour un meilleur alignement vertical */
            border: 1px solid #bbb;
            border-radius: 4px;
            background-color: #fefefe;
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box;
            min-height: auto; /* Nécessaire pour Choices.js */
        }

        /* Ajustement pour que la bordure ne change pas de couleur au focus */
        .is-focused .choices__inner {
            border-color: #bbb;
        }

        .date-input-group input[type="date"] {
            flex-grow: 1; /* L'input s'étire */
        }

        .date-input-group button {
            flex-shrink: 0; /* Les boutons ne rétrécissent pas */
        }

        /* Boutons */
        button {
            padding: 0.6rem 1.2rem;
            background-color: #001f3f;
            color: #fff8e1;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #003366;
        }

        .view-options label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #444;
            font-size: 0.95rem;
            font-weight: bold;
        }

        #titre_odb label {
            font-weight: bold;
            color: #2b2b2b;
        }

        /* --- AJOUTS POUR LA MISE EN PAGE --- */

        /* 1. Le conteneur principal devient un conteneur flex */
        .main-container {
            display: flex;
            /* Calcule la hauteur restante de la fenêtre (100vh) moins la hauteur approximative du header */
            height: calc(100vh - 105px); /* Ajustez cette valeur si votre header change */
        }

        /* 2. On donne une taille fixe au panneau de contrôle (l'ancienne section.controls) */
        .main-container .controls {
            flex: 0 0 380px; /* Ne grandit pas, ne rétrécit pas, largeur de base 380px */
            padding: 1.5rem;
            background-color: #ffffff;
            overflow-y: auto; /* Ajoute une barre de défilement si le contenu est trop grand */
            border-right: 2px solid #ded6c3; /* Ligne de séparation */
        }

        .main-container .controls .choices {
          width: 300px;
        }

        /* 3. La carte prend tout le reste de la place */
        .main-container #map {
            flex-grow: 1; /* Permet à la carte de grandir */
            height: 100%; /* La carte prend 100% de la hauteur de son parent */
        }

    </style>
</head>
<body>
    <header>
        <h1>Carte de la campagne de France (Déc 1813 - Avril 1814)</h1>
    </header>

    <main class="main-container">

        <section class="controls">
            <div class="control-group">
                <div class="form-item">
                    <label for="dateSelect">Sélectionner une date :</label>
                    <div class="date-input-group">
                        <input type="date" id="dateSelect" min="1813-12-01" max="1814-04-30" value="1814-01-01">
                        <button onclick="decrementDate()" title="Jour précédent">«</button>
                        <button onclick="incrementDate()" title="Jour suivant">»</button>
                    </div>
                </div>

                <div class="form-item">
                    <label for="unitSelect">Sélectionner une unité :</label>
                    <select id="unitSelect" name="unitSelect"></select>
                </div>

                <div class="view-options" id="filters">
                    <label>
                        <input type="checkbox" id="planifieSelect" name="type">
                        Masquer les lieux objectifs
                    </label>
                </div>
                <div id="titre_odb">
                  <label>A sous ses ordres : </label>
                  <ul id="commande"></ul>
                  <label>Est sous les ordres de : </label>
                  <ul id="dirige_par"></ul>
                </div>
                
            </div>
        </section>

        <div id="map"></div>

    </main>
</body>
</html>

  <script>

    document.getElementById('titre_odb').style.display = "none";

    // Ajout des deux couches Cassini et Etat-major
    const layer_cassini_etat_major = [
          { id: "cassini", type: "raster", source: "cassini", layout: { visibility: "none" } },
          { id: "etatmajor", type: "raster", source: "etatmajor", layout: { visibility: "none" } },
        ]    
    
    const map = new maplibregl.Map({
      container: "map",
      style: {
        version: 8,
        glyphs:"https://openmaptiles.geo.data.gouv.fr/fonts/{fontstack}/{range}.pbf",
        sprite:"https://openmaptiles.github.io/osm-bright-gl-style/sprite",
        sources: {
          cassini: {
            type: "raster",
            tiles: [
              "https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0" +
              "&LAYER=BNF-IGNF_GEOGRAPHICALGRIDSYSTEMS.CASSINI" +
              "&STYLE=normal" + 
              "&TILEMATRIX={z}&TILECOL={x}&TILEROW={y}&FORMAT=image/png" +
              "&TileMatrixSet=PM"
            ],
            tileSize: 256
          },
          etatmajor: {
            type: "raster",
            tiles: [
              "https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0" +
              "&LAYER=GEOGRAPHICALGRIDSYSTEMS.ETATMAJOR40" +
              "&STYLE=normal" + 
              "&TILEMATRIX={z}&TILECOL={x}&TILEROW={y}&FORMAT=image/jpeg" +
              "&TileMatrixSet=PM"
            ],
            tileSize: 256
          },
          plan_ign: {
            type: "vector",
            tiles: [
              "https://data.geopf.fr/tms/1.0.0/PLAN.IGN/{z}/{x}/{y}.pbf"
            ],
          }
        },
        layers: layer_cassini_etat_major.concat(CarteFacile.mapStyles.simple.layers)
      },
      center: [2.2, 48.8],
      zoom: 6
    });


    
    // Choix du fond de carte avec les boutons radio
    class BasemapControl {
      onAdd(map) {
        this._map = map;
        this._container = document.createElement('div');
        this._container.className = 'maplibregl-ctrl maplibregl-ctrl-group';
        this._container.style.background = 'white';
        this._container.style.padding = '6px';
        this._container.style.fontFamily = 'sans-serif';
        this._container.style.fontSize = '13px';

        const form = document.createElement('form');
        form.innerHTML = `
          <label>
            <input type="radio" name="basemap" value="plan_ign" checked>
            Carte IGN
          </label><br>
          <label>
            <input type="radio" name="basemap" value="cassini">
            Carte de Cassini
          </label><br>
          <label>
            <input type="radio" name="basemap" value="etatmajor">
            Carte de l'état-major (1820-1866)
          </label>
        `;

        form.onchange = (e) => {
          if (e.target.name === 'basemap') {
            var layers = map.getStyle().layers;
            layers.forEach(layer => {              
              if (layer.source==e.target.value) {
                map.setLayoutProperty(layer.id, 'visibility', 'visible');
              }
              else if (layer.source=="positions" || layer.source=="combats"){
                map.setLayoutProperty(layer.id, 'visibility', 'visible');
              }
              else{
                map.setLayoutProperty(layer.id, 'visibility', 'none');
              }
            });            
          }
        };

        this._container.appendChild(form);
        return this._container;
      }

    }

    // Ajout du contrôle dans un coin (ici en haut à gauche)
    map.addControl(new BasemapControl(), 'top-left');



    const scale = new maplibregl.ScaleControl({
      maxWidth: 200,
      unit: 'metric'
    });
    const nav = new maplibregl.NavigationControl();
    map.addControl(nav, 'top-right');

    // Couleur des cercles pour afficher les unités sur la carte
    const circle_color = [
      'match',
      ['get', 'camp'],
      'FRANCAIS', '#1d4ed8',     // bleu
      'COALISES', '#e74c3c',     // rouge
      '#cccccc'
    ]

    // Instanciation des couches
    map.addControl(scale);
    map.on('load', async () => {
      
      // On ajoute l'icône pour les combats
      image = await map.loadImage('/static/icons/lieu_combat.png');
      map.addImage('icone_combat', image.data);
      
      // On ajoute la couche des positions
      map.addSource('positions', {
        type: 'geojson',
        data: {
          type: 'FeatureCollection',
          features: []
        }
      });

      // On ajoute la couche des combats
      map.addSource('combats', {
        type: 'geojson',
        data: {
          type: 'FeatureCollection',
          features: []
        }
      });

      // Symboles points pour le placement des unités
      map.addLayer({
        id: 'unit-points',
        type: 'circle',
        source: 'positions',
        paint: {
          'circle-radius': 6,
          'circle-color': circle_color,
          'circle-stroke-width': 1,
          'circle-stroke-color': '#fff'
        }
      });

      // Labels avec les dates ou les noms d'unités
      map.addLayer({
        id: 'unites-labels',
        type: 'symbol',
        source: 'positions',
        layout: {
          'text-field': ['get', 'unite'], // ou un autre champ comme 'type'
          'text-offset': [0, 1.2],
          'text-anchor': 'top'
        },
        paint: {
          'text-color': '#000',
          'text-halo-color': '#fff',
          'text-halo-width': 1
        }
      });

      // Icones pour les batailles
      map.addLayer({
          id: 'batailles-layer',
          type: 'symbol',
          source: 'combats',
          layout: {
            'icon-image': 'icone_combat',
            'icon-size': 0.05, // ajuste la taille
            'icon-allow-overlap': true
          }
      });      
    });

    // Pop-up sur les positions
    map.on('click', 'unit-points', (e) => {
      const coordinates = e.features[0].geometry.coordinates.slice();
      const props = e.features[0].properties;      
      new maplibregl.Popup()
        .setLngLat(coordinates)
        .setHTML(props.popup)
        .addTo(map);
    });

    // Pop-up sur les batailles
    map.on('click', 'batailles-layer', (e) => {
      const coordinates = e.features[0].geometry.coordinates.slice();
      const props = e.features[0].properties;      
      new maplibregl.Popup()
        .setLngLat(coordinates)
        .setHTML(props.popup)
        .addTo(map);
    });

    

    // Ajout des courbes de niveau. Pas très utile à cette échelle...
    CarteFacile.addOverlay(map, CarteFacile.Overlay.levelCurves);

    // Mise à jour de la carte lors de la sélection d'une unité
    document.getElementById('unitSelect').addEventListener('change', function () {
      const selectedUnit = this.value;

      fetch(`/positions_par_unite?unite=${selectedUnit}`)
        .then(res => res.json())
        .then(data => {
          if (map.getSource('positions')) {
            map.getSource('positions').setData(data["position"]);
            map.setLayoutProperty('unites-labels', 'text-field', ['get', 'date']);
            map.getSource('combats').setData(data["combats"]);
            
            document.getElementById('titre_odb').style.display = "block";
            const ul = document.getElementById("commande");
            ul.innerHTML = ""; // vider la liste
            // Construire les <li>
            data["a_sous_ses_ordres"].forEach(unite => {
                const li = document.createElement("li");
                li.textContent = unite;
                ul.appendChild(li);
            });

            const ul2 = document.getElementById("dirige_par");
            ul2.innerHTML = ""; // vider la liste
            // Construire les <li>
            data["est_commande_par"].forEach(unite => {
                const li2 = document.createElement("li");
                li2.textContent = unite;
                ul2.appendChild(li2);
            });
          }
        })
      });

    // Mise à jour de la carte lors de la sélection d'une date
    document.getElementById('dateSelect').addEventListener('change', function () {
      const selectedDate = this.value;
      updateDataDate(selectedDate);
    });



    function updateDataDate(selectedDate) {
      fetch(`/positions_par_date?date=${selectedDate}`)
      .then(res => res.json())
      .then(data => {
        if (map.getSource('positions')) {                   
          map.getSource('positions').setData(data["position"]);
          map.setLayoutProperty('unites-labels', 'text-field', ['get', 'unite']);
          map.getSource('combats').setData(data["combats"]);
          document.getElementById('titre_odb').style.display = "none";
        }
      })
    }

    
    // Filtre sur l'état "planifié" des positions
    document.getElementById('filters').addEventListener('change', (e) => {
      const value = document.getElementById("planifieSelect").checked;     
      // Si "Tous", on retire le filtre
      if  (value) {
        map.setFilter('unit-points', ['==', ['get', 'planifie'], false]);
        map.setFilter('unites-labels', ['==', ['get', 'planifie'], false]);
      } else {
        // Sinon, on applique un filtre sur la propriété "type"
        map.setFilter('unit-points', null);
        map.setFilter('unites-labels', null);
      }
    });

    // On remplit le <select> avec le nom des unités
    fetch('/units/')
    .then(response => response.json())
    .then(data => {
      const unitSelect = document.getElementById('unitSelect');
      // Remplir manuellement le <select>
      data.forEach(unit => {
        const option = document.createElement('option');
        option.value = unit.id;
        option.text = unit.text;
        unitSelect.appendChild(option);
      });

      // Initialiser Choices.js après ajout
      new Choices('#unitSelect');
    });


    function decrementDate() {
        const input = document.getElementById('dateSelect');
        if (input.value) {
            const currentDate = new Date(input.value);
            currentDate.setDate(currentDate.getDate() - 1); // soustrait 1 jour
            input.value = currentDate.toISOString().split('T')[0];
        } else {
            const today = new Date();
            today.setDate(today.getDate() - 1);
            input.value = today.toISOString().split('T')[0];
        }
        updateDataDate(input.value);
    }


    // Increment date
    function incrementDate() {
      const input = document.getElementById('dateSelect');
      if (input.value) {
          const currentDate = new Date(input.value);
          currentDate.setDate(currentDate.getDate() + 1); // ajoute 1 jour
          input.value = currentDate.toISOString().split('T')[0]; // format YYYY-MM-DD
      } else {
          // Si aucune date sélectionnée, mettre aujourd’hui + 1
          const today = new Date();
          today.setDate(today.getDate() + 1);
          input.value = today.toISOString().split('T')[0];
      }
      updateDataDate(input.value);
    }

    updateDataDate("1814-01-01");
    

  </script>
</html>
